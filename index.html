<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倒计时</title>
    <!-- Supabase JS 客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* 禁用文本选择，但在输入框和文本区域中允许 */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        body {
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .countdown-card {
            background-color: transparent;
            padding: 30px;
            text-align: center;
        }

        .countdown-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .time-section {
            display: flex;
            align-items: center;
        }

        .time-section span {
            font-size: 120px; /* 增大到120px */
            font-weight: 700;
            color: #37474f;
        }

        #hours, #minutes, #seconds {
            min-width: 200px;
            padding: 15px 0;
        }

        .colon {
            margin: 0 -15px;
        }

        /* 时间选择器样式 */
        .time-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .time-picker-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .time-columns {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .time-column {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            margin: 0 10px;
        }

        .time-item {
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .time-item:hover {
            background-color: #f0f0f0;
        }

        .time-item.selected {
            background-color: #eceff1;
            font-weight: bold;
            color: #37474f;
        }

        .time-picker-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .time-picker-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .confirm-button {
            background-color: #37474f;
            color: white;
        }

        .confirm-button:hover {
            background-color: #455a64;
        }

        .cancel-button {
            background-color: #f0f0f0;
            color: #37474f;
        }

        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        /* 简洁备忘录样式 */
        .memo-container {
            margin-top: -10px;
            width: 100%;
            max-width: 650px;
        }

        #memo-text {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            background-color: rgba(240, 240, 240, 0.5);
            font-size: 16px;
            color: #37474f;
            resize: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            border-radius: 8px;
        }

        #memo-text:focus {
            outline: none;
            background-color: rgba(240, 240, 240, 0.7);
        }

        /* 应用桌面样式 */
        .app-drawer-container {
            position: fixed;
            top: 0;
            left: 100%; /* 从右侧开始 */
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            z-index: 900;
            overflow-y: auto;
            padding: 40px 20px; /* 增加上下内边距 */
            opacity: 0; /* 初始透明 */
            display: flex;
            justify-content: center; /* 水平居中 */
            will-change: transform, opacity; /* 优化性能 */
        }

        /* 当不是拖动状态时使用过渡效果 */
        .app-drawer-container:not(.dragging) {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .app-drawer-container.active {
            transform: translateX(-100%); /* 向左移动100% */
            opacity: 1; /* 完全不透明 */
        }

        /* 主容器动画效果 */
        .container {
            will-change: transform, opacity; /* 优化性能 */
        }

        /* 当不是拖动状态时使用过渡效果 */
        .container:not(.dragging) {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .container.drawer-active {
            transform: translateX(-30%); /* 主界面左移 */
            opacity: 0.3; /* 降低不透明度 */
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            padding: 20px 0;
            max-width: 800px; /* 限制最大宽度 */
            width: 100%;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #37474f;
        }

        .app-icon {
            width: 64px;
            height: 64px;
            background-color: #e0e0e0;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            font-size: 24px;
            color: #37474f;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .app-icon:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* 长按效果 */
        .app-icon.long-press {
            transform: scale(0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            background-color: #d0d0d0;
        }

        .app-name {
            font-size: 14px;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 8px; /* 统一间距 */
        }

        .add-app-button {
            background-color: #e0e0e0;
            font-size: 32px;
            color: #37474f;
            cursor: pointer;
            border: 2px dashed #b0b0b0;
            transition: background-color 0.2s ease;
        }

        .add-app-button:hover {
            background-color: #d0d0d0;
        }

        /* 应用编辑弹窗 */
        .app-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .app-edit-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .app-edit-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #37474f;
        }

        .app-edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: #37474f;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #37474f;
        }

        .app-edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .app-edit-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .save-button {
            background-color: #37474f;
            color: white;
        }

        .save-button:hover {
            background-color: #455a64;
        }

        .cancel-button {
            background-color: #f0f0f0;
            color: #37474f;
        }

        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        .delete-button {
            background-color: #f44336;
            color: white;
            margin-right: auto;
        }

        .delete-button:hover {
            background-color: #e53935;
        }

        /* Powered by 文本样式 */
        .powered-by {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: #9e9e9e;
            opacity: 0.7;
            z-index: 1200; /* 增加z-index值，使其高于应用抽屉(900)和编辑弹窗(1100) */
        }

    /* 响应式设计 */
        @media (max-width: 500px) {
            .countdown-card {
                padding: 20px;
            }

            .time-section span {
                font-size: 48px; /* 响应式下调整为更合适的大小 */
            }

            #hours, #minutes, #seconds {
                min-width: 80px;
                padding: 10px 0;
            }

            .colon {
                margin: 0 -5px;
            }

            #memo-text {
                height: 120px;
                font-size: 16px; /* 保持标准阅读字体大小 */
                padding: 10px;
            }

            .app-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 15px;
            }

            .app-icon {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }

            .app-name {
                font-size: 12px;
                max-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="countdown-card">
            <div class="countdown-display" id="countdown-display">
                <div class="time-section">
                    <span id="hours">00</span>
                </div>
                <div class="time-section">
                    <span class="colon">:</span>
                </div>
                <div class="time-section">
                    <span id="minutes">00</span>
                </div>
                <div class="time-section">
                    <span class="colon">:</span>
                </div>
                <div class="time-section">
                    <span id="seconds">00</span>
                </div>
            </div>
        </div>

        <!-- 极简备忘录 -->
        <div class="memo-container">
            <textarea id="memo-text" spellcheck="false"></textarea>
        </div>
    </div>

    <!-- 应用桌面抽屉 -->
    <div class="app-drawer-container" id="app-drawer">
        <div class="app-grid" id="app-grid">
            <!-- 应用图标将通过JS动态生成 -->
            <div class="app-item" id="add-app">
                <div class="app-icon add-app-button">+</div>
                <div class="app-name">添加应用</div>
            </div>
        </div>
    </div>

    <!-- 应用编辑弹窗 -->
    <div class="app-edit-modal" id="app-edit-modal">
        <div class="app-edit-content">
            <div class="app-edit-title" id="app-edit-title">添加应用</div>
            <div class="app-edit-form">
                <div class="form-group">
                    <label for="app-name-input">应用名称</label>
                    <input type="text" id="app-name-input" placeholder="输入应用名称">
                </div>
                <div class="form-group">
                    <label for="app-url-input">网址</label>
                    <input type="url" id="app-url-input" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="app-icon-input">图标 (可选，使用字母或Emoji)</label>
                    <input type="text" id="app-icon-input" placeholder="例如: G, 📝, 🎮" maxlength="2">
                </div>
            </div>
            <div class="app-edit-buttons">
                <button class="app-edit-button delete-button" id="delete-app-button" style="display: none;">删除</button>
                <button class="app-edit-button cancel-button" id="cancel-app-button">取消</button>
                <button class="app-edit-button save-button" id="save-app-button">保存</button>
            </div>
        </div>
    </div>

    <!-- 时间选择器弹窗 -->
    <div class="time-picker-modal" id="time-picker-modal">
        <div class="time-picker-content">
            <div class="time-columns">
                <div class="time-column" id="hour-column">
                    <!-- 小时选项将通过JS动态生成 -->
                </div>
                <div class="time-column" id="minute-column">
                    <!-- 分钟选项将通过JS动态生成 -->
                </div>
            </div>
            <div class="time-picker-buttons">
                <button class="time-picker-button cancel-button" id="cancel-button">取消</button>
                <button class="time-picker-button confirm-button" id="confirm-button">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 默认目标时间
        let targetHour = 23;
        let targetMinute = 0;

        // 时间选择器变量
        let selectedHour = targetHour;
        let selectedMinute = targetMinute;

        // DOM 元素
        let modal, hourColumn, minuteColumn, confirmButton, cancelButton, countdownDisplay;

        // 初始化时间选择器
        function initTimePicker() {
            // 生成小时选项 (1-24)
            for (let i = 1; i <= 24; i++) {
                const hourItem = document.createElement('div');
                hourItem.className = 'time-item';
                hourItem.textContent = i.toString().padStart(2, '0');
                hourItem.dataset.value = i;
                hourItem.addEventListener('click', () => selectHour(i));
                hourColumn.appendChild(hourItem);
            }

            // 生成分钟选项 (00 和 30)
            const minuteValues = [0, 30];
            minuteValues.forEach(min => {
                const minuteItem = document.createElement('div');
                minuteItem.className = 'time-item';
                minuteItem.textContent = min.toString().padStart(2, '0');
                minuteItem.dataset.value = min;
                minuteItem.addEventListener('click', () => selectMinute(min));
                minuteColumn.appendChild(minuteItem);
            });

            // 设置按钮事件
            confirmButton.addEventListener('click', confirmTimeSelection);
            cancelButton.addEventListener('click', closeTimePicker);

            // 点击倒计时显示打开时间选择器
            countdownDisplay.addEventListener('click', openTimePicker);
        }

        // 打开时间选择器
        function openTimePicker() {
            selectedHour = targetHour;
            selectedMinute = targetMinute;

            // 重置选中状态
            updateTimePickerSelection();

            // 显示模态框
            modal.style.display = 'flex';
        }

        // 关闭时间选择器
        function closeTimePicker() {
            modal.style.display = 'none';
        }

        // 选择小时
        function selectHour(hour) {
            selectedHour = hour;
            updateTimePickerSelection();
        }

        // 选择分钟
        function selectMinute(minute) {
            selectedMinute = minute;
            updateTimePickerSelection();
        }

        // 更新时间选择器的选中状态
        function updateTimePickerSelection() {
            // 更新小时选中状态
            Array.from(hourColumn.children).forEach(item => {
                if (parseInt(item.dataset.value) === selectedHour) {
                    item.classList.add('selected');
                    // 滚动到可见区域
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.classList.remove('selected');
                }
            });

            // 更新分钟选中状态
            Array.from(minuteColumn.children).forEach(item => {
                if (parseInt(item.dataset.value) === selectedMinute) {
                    item.classList.add('selected');
                    // 滚动到可见区域
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 确认时间选择
        function confirmTimeSelection() {
            targetHour = selectedHour;
            targetMinute = selectedMinute;
            saveSettings();
            closeTimePicker();
        }

        // 从本地存储加载设置（如果有）
        function loadSettings() {
            const savedSettings = localStorage.getItem('bedtimeSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    targetHour = settings.targetHour || 23;
                    targetMinute = settings.targetMinute || 0;
                } catch (e) {
                    console.error("加载设置时出错:", e);
                }
            }
        }

        // 保存设置
        function saveSettings() {
            try {
                const settings = {
                    targetHour: targetHour,
                    targetMinute: targetMinute
                };

                localStorage.setItem('bedtimeSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("保存设置时出错:", e);
                alert("保存设置失败: " + e.message);
            }
        }

        // 更新倒计时
        function updateCountdown() {
            const now = new Date();

            // 设置目标时间为今天的目标时间点
            let targetTime = new Date();
            targetTime.setHours(targetHour, targetMinute, 0, 0);

            // 如果当前时间已经过了今天的目标时间，则目标时间设为明天的目标时间
            if (now >= targetTime) {
                targetTime.setDate(targetTime.getDate() + 1);
            }

            // 计算剩余时间（毫秒）
            const timeLeft = targetTime - now;

            // 转换为小时、分钟和秒
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            // 更新显示
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

            // 设置文档标题，只显示倒计时数字
            document.title = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 备忘录功能
        let memoText;
        let lastSyncTime = null;
        let syncInProgress = false;
        let syncCode = null;
        let lastLocalUpdate = new Date().toISOString();
        let syncCheckInterval = null;

        // 初始化备忘录
        async function initMemo() {
            memoText = document.getElementById('memo-text');

            // 获取同步码
            syncCode = getSyncCode();

            // 尝试从Supabase加载内容
            await loadMemoFromSupabase();

            // 如果没有从Supabase加载到内容，则尝试从本地加载
            if (!memoText.value) {
                const savedMemo = localStorage.getItem('bedtimeMemo');
                if (savedMemo) {
                    memoText.value = savedMemo;
                    // 将本地内容保存到Supabase
                    await saveMemoToSupabase(syncCode, savedMemo);
                }
            }

            // 添加事件监听器，自动保存
            memoText.addEventListener('input', saveMemo);

            // 添加双击事件，显示同步码
            memoText.addEventListener('dblclick', showSyncCode);

            // 设置定期检查更新的定时器
            syncCheckInterval = setInterval(checkForMemoUpdates, 30000); // 每30秒检查一次
        }

        // 保存备忘录内容
        async function saveMemo() {
            const content = memoText.value;

            // 保存到本地
            localStorage.setItem('bedtimeMemo', content);
            lastLocalUpdate = new Date().toISOString();
            localStorage.setItem('bedtimeLastUpdate', lastLocalUpdate);

            // 保存到Supabase
            if (!syncInProgress) {
                syncInProgress = true;
                try {
                    console.log('正在保存到Supabase，同步码:', syncCode);
                    const result = await saveMemoToSupabase(syncCode, content);
                    lastSyncTime = new Date();
                    console.log('保存到Supabase成功:', result);
                } catch (error) {
                    console.error('保存到Supabase失败:', error);
                } finally {
                    syncInProgress = false;
                }
            }
        }

        // 从Supabase加载备忘录内容
        async function loadMemoFromSupabase() {
            try {
                const data = await fetchMemoFromSupabase(syncCode);
                if (data && data.content) {
                    // 比较本地和远程的更新时间
                    const localLastUpdate = localStorage.getItem('bedtimeLastUpdate');

                    if (!localLastUpdate || new Date(data.updated_at) > new Date(localLastUpdate)) {
                        memoText.value = data.content;
                        localStorage.setItem('bedtimeMemo', data.content);
                        localStorage.setItem('bedtimeLastUpdate', data.updated_at);
                        lastLocalUpdate = data.updated_at;
                        console.log('从Supabase加载了更新的内容');
                    }

                    lastSyncTime = new Date();
                    return true;
                }
            } catch (error) {
                console.error('从Supabase加载失败:', error);
            }
            return false;
        }

        // 定期检查Supabase是否有更新
        async function checkForMemoUpdates() {
            if (syncInProgress) return;

            try {
                syncInProgress = true;
                const hasUpdates = await checkForUpdates(syncCode, lastLocalUpdate);

                if (hasUpdates) {
                    console.log('检测到Supabase有更新，正在加载...');
                    await loadMemoFromSupabase();
                }
            } catch (error) {
                console.error('检查更新失败:', error);
            } finally {
                syncInProgress = false;
            }
        }

        // 生成同步码
        function generateSyncCode() {
            const adjectives = ['快乐', '聪明', '勇敢', '温柔', '活泼', '安静', '明亮', '敏捷', '友好', '善良'];
            const nouns = ['猫咪', '狗狗', '兔子', '熊猫', '老虎', '狮子', '大象', '长颈鹿', '海豚', '企鹅'];

            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 100);

            return `${randomAdjective}-${randomNoun}-${randomNumber}`;
        }

        // 获取同步码
        function getSyncCode() {
            let code = localStorage.getItem('bedtimeSyncCode');
            if (!code) {
                code = generateSyncCode();
                localStorage.setItem('bedtimeSyncCode', code);
            }
            return code;
        }

        // 从Supabase获取备忘录内容
        async function fetchMemoFromSupabase(syncCode) {
            const { data, error } = await supabase
                .from('memo_sync')
                .select('content, updated_at')
                .eq('sync_code', syncCode)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 是"没有找到结果"的错误
                console.error('从Supabase获取备忘录时出错:', error);
                return null;
            }

            return data;
        }

        // 保存备忘录内容到Supabase
        async function saveMemoToSupabase(syncCode, content) {
            const { error } = await supabase
                .from('memo_sync')
                .upsert({
                    sync_code: syncCode,
                    content: content,
                    updated_at: new Date().toISOString()
                });

            if (error) {
                console.error('保存备忘录到Supabase时出错:', error);
                return false;
            }

            return true;
        }

        // 检查Supabase是否有更新
        async function checkForUpdates(syncCode, localUpdatedAt) {
            const { data, error } = await supabase
                .from('memo_sync')
                .select('updated_at')
                .eq('sync_code', syncCode)
                .single();

            if (error) {
                if (error.code === 'PGRST116') { // 没有找到结果
                    return false;
                }
                console.error('检查更新时出错:', error);
                return false;
            }

            if (!data) return false;

            // 比较时间戳
            const remoteUpdatedAt = new Date(data.updated_at);
            const localDate = new Date(localUpdatedAt);

            return remoteUpdatedAt > localDate;
        }

        // 显示同步码
        function showSyncCode() {
            const code = getSyncCode();
            alert(`您的同步码是: ${code}\n\n请记住这个同步码，您可以在其他设备上使用它来同步备忘录内容。`);
        }

        // 设置同步码（用于在其他设备上输入同步码）
        function setSyncCode(newCode) {
            if (newCode && newCode.trim() !== '') {
                localStorage.setItem('bedtimeSyncCode', newCode.trim());
                syncCode = newCode.trim();
                loadMemoFromSupabase(); // 立即尝试加载
                return true;
            }
            return false;
        }

        // 应用桌面功能
        let appDrawer, appGrid, addAppButton;
        let appEditModal, appNameInput, appUrlInput, appIconInput;
        let saveAppButton, cancelAppButton, deleteAppButton, appEditTitle;
        let currentEditingAppId = null;
        let apps = [];

        // 初始化应用桌面
        function initAppDrawer() {
            appDrawer = document.getElementById('app-drawer');
            appGrid = document.getElementById('app-grid');
            addAppButton = document.getElementById('add-app');

            // 不再为整个按钮添加点击事件，只在图标上添加

            // 加载保存的应用
            loadApps();
            renderApps();

            // 添加滑动手势检测
            initSwipeDetection();
        }

        // 初始化应用编辑弹窗
        function initAppEditModal() {
            appEditModal = document.getElementById('app-edit-modal');
            appNameInput = document.getElementById('app-name-input');
            appUrlInput = document.getElementById('app-url-input');
            appIconInput = document.getElementById('app-icon-input');
            saveAppButton = document.getElementById('save-app-button');
            cancelAppButton = document.getElementById('cancel-app-button');
            deleteAppButton = document.getElementById('delete-app-button');
            appEditTitle = document.getElementById('app-edit-title');

            // 设置按钮事件
            saveAppButton.addEventListener('click', saveApp);
            cancelAppButton.addEventListener('click', closeAppEditModal);
            deleteAppButton.addEventListener('click', deleteApp);
        }

        // 打开应用编辑弹窗
        function openAppEditModal(appId = null) {
            currentEditingAppId = appId;

            if (appId) {
                // 编辑现有应用
                const app = apps.find(a => a.id === appId);
                if (app) {
                    appNameInput.value = app.name;
                    appUrlInput.value = app.url;
                    appIconInput.value = app.icon || '';
                    appEditTitle.textContent = '编辑应用';
                    deleteAppButton.style.display = 'block';
                }
            } else {
                // 添加新应用
                appNameInput.value = '';
                appUrlInput.value = '';
                appIconInput.value = '';
                appEditTitle.textContent = '添加应用';
                deleteAppButton.style.display = 'none';
            }

            appEditModal.style.display = 'flex';
        }

        // 关闭应用编辑弹窗
        function closeAppEditModal() {
            appEditModal.style.display = 'none';
            currentEditingAppId = null;
        }

        // 保存应用
        function saveApp() {
            const name = appNameInput.value.trim();
            const url = appUrlInput.value.trim();
            const icon = appIconInput.value.trim();

            if (!name) {
                alert('请输入应用名称');
                return;
            }

            if (!url) {
                alert('请输入网址');
                return;
            }

            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                alert('请输入有效的网址，包含http://或https://');
                return;
            }

            if (currentEditingAppId) {
                // 更新现有应用
                const index = apps.findIndex(a => a.id === currentEditingAppId);
                if (index !== -1) {
                    apps[index] = {
                        ...apps[index],
                        name,
                        url,
                        icon
                    };
                }
            } else {
                // 添加新应用
                const newApp = {
                    id: Date.now().toString(),
                    name,
                    url,
                    icon,
                    createdAt: new Date().toISOString()
                };
                apps.push(newApp);
            }

            // 保存并重新渲染
            saveApps();
            renderApps();
            closeAppEditModal();
        }

        // 删除应用
        function deleteApp() {
            if (!currentEditingAppId) return;

            const confirmed = confirm('确定要删除这个应用吗？');
            if (!confirmed) return;

            apps = apps.filter(a => a.id !== currentEditingAppId);
            saveApps();
            renderApps();
            closeAppEditModal();
        }

        // 全局变量，用于跟踪是否正在拖动
        let isGlobalDragging = false;
        let touchMoveDistance = 0;

        // 渲染应用列表
        function renderApps() {
            // 清除现有应用（保留添加按钮）
            while (appGrid.firstChild && appGrid.firstChild.id !== 'add-app') {
                appGrid.removeChild(appGrid.firstChild);
            }

            // 添加应用图标
            apps.forEach(app => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                appItem.dataset.id = app.id;

                const appIcon = document.createElement('div');
                appIcon.className = 'app-icon';
                appIcon.textContent = app.icon || app.name.charAt(0).toUpperCase();

                const appName = document.createElement('div');
                appName.className = 'app-name';
                appName.textContent = app.name;

                appItem.appendChild(appIcon);
                appItem.appendChild(appName);

                // 点击打开网址 - 使用mouseup/touchend而不是click
                let appTouchStartX = 0;
                let appTouchStartY = 0;
                let appTouchMoved = false;

                // 使用pointer事件实现长按功能
                let longPressTimer;
                let isPointerDown = false;
                let pointerStartX = 0;
                let pointerStartY = 0;
                let hasMoved = false;
                const LONG_PRESS_DURATION = 500; // 长按时间阈值（毫秒）

                // 指针按下事件
                appIcon.addEventListener('pointerdown', (e) => {
                    // 指针按下
                    isPointerDown = true;
                    hasMoved = false;
                    pointerStartX = e.clientX;
                    pointerStartY = e.clientY;

                    // 添加视觉反馈
                    setTimeout(() => {
                        if (isPointerDown && !hasMoved) {
                            // 添加视觉反馈
                            appIcon.classList.add('long-press');
                        }
                    }, 100);

                    // 设置长按计时器
                    longPressTimer = setTimeout(() => {
                        if (isPointerDown && !hasMoved) {
                            // 检测到长按

                            // 震动反馈（如果设备支持）
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                                // 震动反馈已触发
                            }

                            // 打开编辑模式
                            openAppEditModal(app.id);

                            // 防止后续触发点击事件
                            hasMoved = true;
                        }
                    }, LONG_PRESS_DURATION);

                    // 阻止事件冒泡和默认行为
                    e.stopPropagation();
                    e.preventDefault();
                });

                // 指针移动事件
                appIcon.addEventListener('pointermove', (e) => {
                    if (!isPointerDown) return;

                    const moveX = Math.abs(e.clientX - pointerStartX);
                    const moveY = Math.abs(e.clientY - pointerStartY);

                    // 如果移动超过10px，标记为已移动
                    if (moveX > 10 || moveY > 10) {
                        // 指针移动超过阈值
                        hasMoved = true;
                        clearTimeout(longPressTimer);
                        appIcon.classList.remove('long-press'); // 移除长按效果
                    }

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                // 指针释放事件
                appIcon.addEventListener('pointerup', (e) => {
                    // 指针释放

                    // 清除长按计时器
                    clearTimeout(longPressTimer);

                    // 移除视觉反馈
                    appIcon.classList.remove('long-press');

                    // 如果没有移动且不是全局拖动状态，则视为点击
                    if (!hasMoved && !isGlobalDragging) {
                        // 触发点击事件，打开网址
                        // 正常点击打开网址
                        window.open(app.url, '_blank');
                    }

                    // 重置状态
                    isPointerDown = false;

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                // 指针离开事件
                appIcon.addEventListener('pointerleave', (e) => {
                    // 指针离开

                    // 清除长按计时器
                    clearTimeout(longPressTimer);

                    // 移除视觉反馈
                    appIcon.classList.remove('long-press');

                    // 重置状态
                    isPointerDown = false;

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                // 添加contextmenu事件作为备用方案
                appIcon.addEventListener('contextmenu', (e) => {
                    // 检测到contextmenu事件（长按）
                    e.preventDefault();

                    // 打开编辑模式
                    openAppEditModal(app.id);

                    return false;
                });

                // 鼠标事件 - 使用mousedown/mouseup而不是click
                let appMouseStartX = 0;
                let appMouseStartY = 0;
                let appMouseMoved = false;

                appIcon.addEventListener('mousedown', (e) => {
                    appMouseStartX = e.clientX;
                    appMouseStartY = e.clientY;
                    appMouseMoved = false;

                    // 编辑模式（按住Shift或Ctrl键点击）
                    if (e.shiftKey || e.ctrlKey) {
                        openAppEditModal(app.id);
                    }

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                appIcon.addEventListener('mousemove', (e) => {
                    if (e.buttons === 1) { // 鼠标左键按下
                        const moveX = Math.abs(e.clientX - appMouseStartX);
                        const moveY = Math.abs(e.clientY - appMouseStartY);

                        // 如果移动超过10px，标记为已移动
                        if (moveX > 10 || moveY > 10) {
                            appMouseMoved = true;
                        }
                    }

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                appIcon.addEventListener('mouseup', (e) => {
                    // 只有在没有移动且不是全局拖动状态时才触发点击
                    if (!appMouseMoved && !isGlobalDragging && !e.shiftKey && !e.ctrlKey) {
                        // 正常点击打开网址
                        window.open(app.url, '_blank');
                    }

                    // 阻止事件冒泡
                    e.stopPropagation();
                });

                // 将应用添加到网格中（在添加按钮之前）
                appGrid.insertBefore(appItem, addAppButton);
            });

            // 为添加应用按钮添加类似的处理
            let addAppTouchStartX = 0;
            let addAppTouchStartY = 0;
            let addAppTouchMoved = false;

            // 移除现有的点击事件
            addAppButton.removeEventListener('click', () => openAppEditModal());

            // 获取添加按钮的图标元素
            const addAppIcon = addAppButton.querySelector('.add-app-button');

            // 使用pointer事件实现点击功能
            let addLongPressTimer;
            let addIsPointerDown = false;
            let addPointerStartX = 0;
            let addPointerStartY = 0;
            let addHasMoved = false;

            // 指针按下事件
            addAppIcon.addEventListener('pointerdown', (e) => {
                addIsPointerDown = true;
                addHasMoved = false;
                addPointerStartX = e.clientX;
                addPointerStartY = e.clientY;

                // 添加视觉反馈
                setTimeout(() => {
                    if (addIsPointerDown && !addHasMoved) {
                        addAppIcon.classList.add('long-press');
                    }
                }, 100);

                // 阻止事件冒泡和默认行为
                e.stopPropagation();
                e.preventDefault();
            });

            // 指针移动事件
            addAppIcon.addEventListener('pointermove', (e) => {
                if (!addIsPointerDown) return;

                const moveX = Math.abs(e.clientX - addPointerStartX);
                const moveY = Math.abs(e.clientY - addPointerStartY);

                // 如果移动超过10px，标记为已移动
                if (moveX > 10 || moveY > 10) {
                    addHasMoved = true;
                    addAppIcon.classList.remove('long-press'); // 移除长按效果
                }

                // 阻止事件冒泡
                e.stopPropagation();
            });

            // 指针释放事件
            addAppIcon.addEventListener('pointerup', (e) => {
                // 移除视觉反馈
                addAppIcon.classList.remove('long-press');

                // 如果没有移动且不是全局拖动状态，则视为点击
                if (!addHasMoved && !isGlobalDragging) {
                    openAppEditModal();
                }

                // 重置状态
                addIsPointerDown = false;

                // 阻止事件冒泡
                e.stopPropagation();
            });

            // 指针离开事件
            addAppIcon.addEventListener('pointerleave', (e) => {
                // 移除视觉反馈
                addAppIcon.classList.remove('long-press');

                // 重置状态
                addIsPointerDown = false;

                // 阻止事件冒泡
                e.stopPropagation();
            });

            // 添加contextmenu事件作为备用方案
            addAppIcon.addEventListener('contextmenu', (e) => {
                e.preventDefault();

                // 打开编辑模式
                openAppEditModal();

                return false;
            });

            // 添加新的鼠标事件 - 只在图标上添加事件
            let addAppMouseStartX = 0;
            let addAppMouseStartY = 0;
            let addAppMouseMoved = false;

            addAppIcon.addEventListener('mousedown', (e) => {
                addAppMouseStartX = e.clientX;
                addAppMouseStartY = e.clientY;
                addAppMouseMoved = false;

                // 阻止事件冒泡
                e.stopPropagation();
            });

            addAppIcon.addEventListener('mousemove', (e) => {
                if (e.buttons === 1) {
                    const moveX = Math.abs(e.clientX - addAppMouseStartX);
                    const moveY = Math.abs(e.clientY - addAppMouseStartY);

                    if (moveX > 10 || moveY > 10) {
                        addAppMouseMoved = true;
                    }
                }

                // 阻止事件冒泡
                e.stopPropagation();
            });

            addAppIcon.addEventListener('mouseup', (e) => {
                if (!addAppMouseMoved && !isGlobalDragging) {
                    openAppEditModal();
                }

                // 阻止事件冒泡
                e.stopPropagation();
            });
        }

        // 默认应用配置 - 在这里配置您想要的默认应用
        const defaultApps = [
            {
                id: 'default-1',
                name: '文本工具',
                url: 'https://xuperbad.github.io/mdSplitter/md_splitter.html',
                icon: 'MD',
                isDefault: true
            },
            // 您可以在这里添加更多默认应用
        ];

        // 从本地存储加载应用
        function loadApps() {
            const savedApps = localStorage.getItem('bedtimeApps');
            let loadedApps = [];

            if (savedApps) {
                try {
                    loadedApps = JSON.parse(savedApps);

                    // 确保所有默认应用都存在
                    ensureDefaultApps(loadedApps);

                    // 更新应用列表
                    apps = loadedApps;
                } catch (e) {
                    console.error("加载应用时出错:", e);
                    // 如果加载出错，使用默认应用
                    apps = [...defaultApps];
                    saveApps();
                }
            } else {
                // 如果没有保存的应用，使用默认应用
                apps = [...defaultApps];
                saveApps();
            }
        }

        // 确保默认应用存在
        function ensureDefaultApps(loadedApps) {
            // 检查每个默认应用是否存在
            defaultApps.forEach(defaultApp => {
                const exists = loadedApps.some(app =>
                    app.url === defaultApp.url || app.id === defaultApp.id
                );

                // 如果不存在，添加到加载的应用列表中
                if (!exists) {
                    loadedApps.push({
                        ...defaultApp,
                        createdAt: new Date().toISOString()
                    });
                }
            });
        }

        // 保存应用到本地存储
        function saveApps() {
            try {
                localStorage.setItem('bedtimeApps', JSON.stringify(apps));
            } catch (e) {
                console.error("保存应用时出错:", e);
                alert("保存应用失败: " + e.message);
            }
        }

        // 获取主容器元素
        let mainContainer;

        // 打开应用抽屉
        function openAppDrawer() {
            // 移除内联样式，使用类来控制
            appDrawer.style.transform = '';
            appDrawer.style.opacity = '';
            mainContainer.style.transform = '';
            mainContainer.style.opacity = '';

            // 添加激活类
            appDrawer.classList.add('active');
            mainContainer.classList.add('drawer-active');
        }

        // 关闭应用抽屉
        function closeAppDrawer() {
            // 移除内联样式，使用类来控制
            appDrawer.style.transform = '';
            appDrawer.style.opacity = '';
            mainContainer.style.transform = '';
            mainContainer.style.opacity = '';

            // 移除激活类
            appDrawer.classList.remove('active');
            mainContainer.classList.remove('drawer-active');
        }

        // 应用抽屉可以通过从右向左滑动屏幕打开

        // 初始化滑动检测
        function initSwipeDetection() {
            let touchStartX = 0;
            let currentTouchX = 0;
            let isDrawerOpen = false;
            let screenWidth = window.innerWidth;

            // 触摸事件处理
            document.body.addEventListener('touchstart', (e) => {
                // 如果是点击按钮或输入框，不处理
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                touchStartX = e.touches[0].clientX;
                currentTouchX = touchStartX;
                isDrawerOpen = appDrawer.classList.contains('active');

                // 添加拖动状态类
                appDrawer.classList.add('dragging');
                mainContainer.classList.add('dragging');

                // 重置移动距离
                touchMoveDistance = 0;
            }, { passive: false });

            document.body.addEventListener('touchmove', (e) => {
                // 如果是点击按钮或输入框，不处理
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                currentTouchX = e.touches[0].clientX;
                const deltaX = currentTouchX - touchStartX;

                // 计算总移动距离（绝对值）
                touchMoveDistance = Math.abs(deltaX);

                // 设置全局拖动状态
                if (touchMoveDistance > 10) {
                    isGlobalDragging = true;
                }

                // 计算移动百分比
                let percent;

                if (isDrawerOpen) {
                    // 如果抽屉已打开，则从左向右拖动时，百分比从100%减少
                    percent = Math.max(0, 100 - (deltaX / screenWidth * 100));
                } else {
                    // 如果抽屉关闭，则从右向左拖动时，百分比从0增加
                    percent = Math.max(0, Math.min(100, -deltaX / screenWidth * 100));
                }

                // 应用实时变换
                updateDrawerPosition(percent);

                // 阻止默认行为，防止页面滚动
                e.preventDefault();
            }, { passive: false });

            document.body.addEventListener('touchend', (e) => {
                const deltaX = currentTouchX - touchStartX;

                // 移除拖动状态类
                appDrawer.classList.remove('dragging');
                mainContainer.classList.remove('dragging');

                // 根据拖动距离和方向决定是打开还是关闭抽屉
                if (isDrawerOpen) {
                    // 如果抽屉已打开，向右拖动超过屏幕宽度的20%则关闭
                    if (deltaX > screenWidth * 0.2) {
                        closeAppDrawer();
                    } else {
                        openAppDrawer(); // 恢复打开状态
                    }
                } else {
                    // 如果抽屉关闭，向左拖动超过屏幕宽度的20%则打开
                    if (deltaX < -screenWidth * 0.2) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer(); // 恢复关闭状态
                    }
                }

                // 延迟重置全局拖动状态，给点击事件处理留出时间
                setTimeout(() => {
                    isGlobalDragging = false;
                }, 50);
            }, { passive: true });

            // 鼠标事件处理（桌面设备）
            let mouseStartX = 0;
            let currentMouseX = 0;
            let isMouseDown = false;

            document.body.addEventListener('mousedown', (e) => {
                // 如果是点击按钮或输入框，不处理
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                isMouseDown = true;
                mouseStartX = e.clientX;
                currentMouseX = mouseStartX;
                isDrawerOpen = appDrawer.classList.contains('active');

                // 添加拖动状态类
                appDrawer.classList.add('dragging');
                mainContainer.classList.add('dragging');

                // 阻止默认行为，防止文本选择
                e.preventDefault();
            });

            document.body.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;

                currentMouseX = e.clientX;
                const deltaX = currentMouseX - mouseStartX;

                // 计算移动百分比
                let percent;

                if (isDrawerOpen) {
                    // 如果抽屉已打开，则从左向右拖动时，百分比从100%减少
                    percent = Math.max(0, 100 - (deltaX / screenWidth * 100));
                } else {
                    // 如果抽屉关闭，则从右向左拖动时，百分比从0增加
                    percent = Math.max(0, Math.min(100, -deltaX / screenWidth * 100));
                }

                // 应用实时变换
                updateDrawerPosition(percent);

                // 阻止默认行为，防止文本选择
                e.preventDefault();
            });

            document.body.addEventListener('mouseup', (e) => {
                if (!isMouseDown) return;

                const deltaX = currentMouseX - mouseStartX;
                const mouseMoveDistance = Math.abs(deltaX);

                // 设置全局拖动状态
                if (mouseMoveDistance > 10) {
                    isGlobalDragging = true;
                }

                // 移除拖动状态类
                appDrawer.classList.remove('dragging');
                mainContainer.classList.remove('dragging');

                // 根据拖动距离和方向决定是打开还是关闭抽屉
                if (isDrawerOpen) {
                    // 如果抽屉已打开，向右拖动超过屏幕宽度的20%则关闭
                    if (deltaX > screenWidth * 0.2) {
                        closeAppDrawer();
                    } else {
                        openAppDrawer(); // 恢复打开状态
                    }
                } else {
                    // 如果抽屉关闭，向左拖动超过屏幕宽度的20%则打开
                    if (deltaX < -screenWidth * 0.2) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer(); // 恢复关闭状态
                    }
                }

                // 重置状态
                isMouseDown = false;

                // 延迟重置全局拖动状态，给点击事件处理留出时间
                setTimeout(() => {
                    isGlobalDragging = false;
                }, 50);
            });

            // 如果鼠标离开页面，也重置状态
            document.body.addEventListener('mouseleave', () => {
                if (isMouseDown) {
                    // 移除拖动状态类
                    appDrawer.classList.remove('dragging');
                    mainContainer.classList.remove('dragging');

                    // 恢复到原始状态
                    if (isDrawerOpen) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer();
                    }

                    isMouseDown = false;

                    // 重置全局拖动状态
                    isGlobalDragging = false;
                }
            });

            // 窗口大小改变时更新屏幕宽度
            window.addEventListener('resize', () => {
                screenWidth = window.innerWidth;
            });
        }

        // 根据百分比更新抽屉位置
        function updateDrawerPosition(percent) {
            // 抽屉位置：从右侧移动到左侧，百分比从0到100
            const drawerTransform = `translateX(${-percent}%)`;
            appDrawer.style.transform = drawerTransform;

            // 抽屉透明度：从0到1，与百分比成正比
            const drawerOpacity = percent / 100;
            appDrawer.style.opacity = drawerOpacity;

            // 主容器位置：向左移动，最多30%
            const containerTransform = `translateX(${-(percent * 0.3)}%)`;
            mainContainer.style.transform = containerTransform;

            // 主容器透明度：从1降到0.3，与百分比成反比
            const containerOpacity = 1 - (percent * 0.7 / 100);
            mainContainer.style.opacity = containerOpacity;
        }

        // 添加键盘快捷键监听
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+S: 设置同步码
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                const newCode = prompt('请输入同步码以从其他设备同步备忘录内容:');
                if (newCode) {
                    if (setSyncCode(newCode)) {
                        alert(`同步码已设置为: ${newCode}\n正在尝试同步...`);
                    } else {
                        alert('同步码无效，请重试。');
                    }
                }
            }
        });

        // 声明全局变量
        let supabase;
        const supabaseUrl = 'https://iohhwiviuugoawsmxjyy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvaGh3aXZpdXVnb2F3c214anl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NzQ5NzYsImV4cCI6MjA2MTE1MDk3Nn0.4KTa7AqBVgurN30gy3han9WTxD2x_7TsMDbdEDxVmSQ';

        // 页面加载完成后初始化
        window.onload = function() {
            // 初始化Supabase客户端
            try {
                // 确保supabase对象存在
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase客户端初始化成功');
                } else {
                    console.error('Supabase对象不存在，请检查脚本是否正确加载');
                }
            } catch (error) {
                console.error('Supabase客户端初始化失败:', error);
            }

            // 初始化DOM元素
            modal = document.getElementById('time-picker-modal');
            hourColumn = document.getElementById('hour-column');
            minuteColumn = document.getElementById('minute-column');
            confirmButton = document.getElementById('confirm-button');
            cancelButton = document.getElementById('cancel-button');
            countdownDisplay = document.getElementById('countdown-display');
            mainContainer = document.querySelector('.container'); // 初始化主容器元素

            // 加载设置
            loadSettings();

            // 初始化时间选择器
            initTimePicker();

            // 初始化备忘录
            initMemo();

            // 初始化应用桌面
            initAppDrawer();
            initAppEditModal();

            // 初始更新
            updateCountdown();

            // 每秒更新一次
            setInterval(updateCountdown, 1000);

            // 显示同步码提示（仅首次使用时）
            const hasShownSyncTip = localStorage.getItem('bedtimeSyncTipShown');
            if (!hasShownSyncTip) {
                setTimeout(() => {
                    alert(`您的备忘录现在支持跨设备同步！\n\n您的同步码是: ${getSyncCode()}\n\n请记住这个同步码，您可以在其他设备上使用它来同步备忘录内容。\n\n提示: 双击备忘录区域可以随时查看您的同步码。\n在其他设备上，按Ctrl+Shift+S可以输入同步码。`);
                    localStorage.setItem('bedtimeSyncTipShown', 'true');
                }, 2000);
            }
        };
    </script>

    <!-- Powered by 文本 -->
    <div class="powered-by">Powered by Chao❤️</div>
</body>
</html>
