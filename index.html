<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€’è®¡æ—¶</title>
    <!-- Supabase JS å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ç¦ç”¨æ–‡æœ¬é€‰æ‹©ï¼Œä½†åœ¨è¾“å…¥æ¡†å’Œæ–‡æœ¬åŒºåŸŸä¸­å…è®¸ */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        body {
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .countdown-card {
            background-color: transparent;
            padding: 30px;
            text-align: center;
        }

        .countdown-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .time-section {
            display: flex;
            align-items: center;
        }

        .time-section span {
            font-size: 120px; /* å¢å¤§åˆ°120px */
            font-weight: 700;
            color: #37474f;
        }

        #hours, #minutes, #seconds {
            min-width: 200px;
            padding: 15px 0;
        }

        .colon {
            margin: 0 -15px;
        }

        /* æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
        .time-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .time-picker-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .time-columns {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .time-column {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            margin: 0 10px;
        }

        .time-item {
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .time-item:hover {
            background-color: #f0f0f0;
        }

        .time-item.selected {
            background-color: #eceff1;
            font-weight: bold;
            color: #37474f;
        }

        .time-picker-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .time-picker-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .confirm-button {
            background-color: #37474f;
            color: white;
        }

        .confirm-button:hover {
            background-color: #455a64;
        }

        .cancel-button {
            background-color: #f0f0f0;
            color: #37474f;
        }

        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        /* ç®€æ´å¤‡å¿˜å½•æ ·å¼ */
        .memo-container {
            margin-top: -10px;
            width: 100%;
            max-width: 650px;
        }

        #memo-text {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            background-color: rgba(240, 240, 240, 0.5);
            font-size: 16px;
            color: #37474f;
            resize: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            border-radius: 8px;
        }

        #memo-text:focus {
            outline: none;
            background-color: rgba(240, 240, 240, 0.7);
        }

        /* åº”ç”¨æ¡Œé¢æ ·å¼ */
        .app-drawer-container {
            position: fixed;
            top: 0;
            left: 100%; /* ä»å³ä¾§å¼€å§‹ */
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            z-index: 900;
            overflow-y: auto;
            padding: 40px 20px; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è· */
            opacity: 0; /* åˆå§‹é€æ˜ */
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            will-change: transform, opacity; /* ä¼˜åŒ–æ€§èƒ½ */
        }

        /* å½“ä¸æ˜¯æ‹–åŠ¨çŠ¶æ€æ—¶ä½¿ç”¨è¿‡æ¸¡æ•ˆæœ */
        .app-drawer-container:not(.dragging) {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .app-drawer-container.active {
            transform: translateX(-100%); /* å‘å·¦ç§»åŠ¨100% */
            opacity: 1; /* å®Œå…¨ä¸é€æ˜ */
        }

        /* ä¸»å®¹å™¨åŠ¨ç”»æ•ˆæœ */
        .container {
            will-change: transform, opacity; /* ä¼˜åŒ–æ€§èƒ½ */
        }

        /* å½“ä¸æ˜¯æ‹–åŠ¨çŠ¶æ€æ—¶ä½¿ç”¨è¿‡æ¸¡æ•ˆæœ */
        .container:not(.dragging) {
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .container.drawer-active {
            transform: translateX(-30%); /* ä¸»ç•Œé¢å·¦ç§» */
            opacity: 0.3; /* é™ä½ä¸é€æ˜åº¦ */
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            padding: 20px 0;
            max-width: 800px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            width: 100%;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #37474f;
        }

        .app-icon {
            width: 64px;
            height: 64px;
            background-color: #e0e0e0;
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            font-size: 24px;
            color: #37474f;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .app-icon:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* é•¿æŒ‰æ•ˆæœ */
        .app-icon.long-press {
            transform: scale(0.9);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            background-color: #d0d0d0;
        }

        .app-name {
            font-size: 14px;
            text-align: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 8px; /* ç»Ÿä¸€é—´è· */
        }

        .add-app-button {
            background-color: #e0e0e0;
            font-size: 32px;
            color: #37474f;
            cursor: pointer;
            border: 2px dashed #b0b0b0;
            transition: background-color 0.2s ease;
        }

        .add-app-button:hover {
            background-color: #d0d0d0;
        }

        /* åº”ç”¨ç¼–è¾‘å¼¹çª— */
        .app-edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .app-edit-content {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .app-edit-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #37474f;
        }

        .app-edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: #37474f;
        }

        .form-group input {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #37474f;
        }

        .app-edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .app-edit-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .save-button {
            background-color: #37474f;
            color: white;
        }

        .save-button:hover {
            background-color: #455a64;
        }

        .cancel-button {
            background-color: #f0f0f0;
            color: #37474f;
        }

        .cancel-button:hover {
            background-color: #e0e0e0;
        }

        .delete-button {
            background-color: #f44336;
            color: white;
            margin-right: auto;
        }

        .delete-button:hover {
            background-color: #e53935;
        }

        /* Powered by æ–‡æœ¬æ ·å¼ */
        .powered-by {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: #9e9e9e;
            opacity: 0.7;
            z-index: 1200; /* å¢åŠ z-indexå€¼ï¼Œä½¿å…¶é«˜äºåº”ç”¨æŠ½å±‰(900)å’Œç¼–è¾‘å¼¹çª—(1100) */
        }

    /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 500px) {
            .countdown-card {
                padding: 20px;
            }

            .time-section span {
                font-size: 48px; /* å“åº”å¼ä¸‹è°ƒæ•´ä¸ºæ›´åˆé€‚çš„å¤§å° */
            }

            #hours, #minutes, #seconds {
                min-width: 80px;
                padding: 10px 0;
            }

            .colon {
                margin: 0 -5px;
            }

            #memo-text {
                height: 120px;
                font-size: 16px; /* ä¿æŒæ ‡å‡†é˜…è¯»å­—ä½“å¤§å° */
                padding: 10px;
            }

            .app-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 15px;
            }

            .app-icon {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }

            .app-name {
                font-size: 12px;
                max-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="countdown-card">
            <div class="countdown-display" id="countdown-display">
                <div class="time-section">
                    <span id="hours">00</span>
                </div>
                <div class="time-section">
                    <span class="colon">:</span>
                </div>
                <div class="time-section">
                    <span id="minutes">00</span>
                </div>
                <div class="time-section">
                    <span class="colon">:</span>
                </div>
                <div class="time-section">
                    <span id="seconds">00</span>
                </div>
            </div>
        </div>

        <!-- æç®€å¤‡å¿˜å½• -->
        <div class="memo-container">
            <textarea id="memo-text" spellcheck="false"></textarea>
        </div>
    </div>

    <!-- åº”ç”¨æ¡Œé¢æŠ½å±‰ -->
    <div class="app-drawer-container" id="app-drawer">
        <div class="app-grid" id="app-grid">
            <!-- åº”ç”¨å›¾æ ‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            <div class="app-item" id="add-app">
                <div class="app-icon add-app-button">+</div>
                <div class="app-name">æ·»åŠ åº”ç”¨</div>
            </div>
        </div>
    </div>

    <!-- åº”ç”¨ç¼–è¾‘å¼¹çª— -->
    <div class="app-edit-modal" id="app-edit-modal">
        <div class="app-edit-content">
            <div class="app-edit-title" id="app-edit-title">æ·»åŠ åº”ç”¨</div>
            <div class="app-edit-form">
                <div class="form-group">
                    <label for="app-name-input">åº”ç”¨åç§°</label>
                    <input type="text" id="app-name-input" placeholder="è¾“å…¥åº”ç”¨åç§°">
                </div>
                <div class="form-group">
                    <label for="app-url-input">ç½‘å€</label>
                    <input type="url" id="app-url-input" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="app-icon-input">å›¾æ ‡ (å¯é€‰ï¼Œä½¿ç”¨å­—æ¯æˆ–Emoji)</label>
                    <input type="text" id="app-icon-input" placeholder="ä¾‹å¦‚: G, ğŸ“, ğŸ®" maxlength="2">
                </div>
            </div>
            <div class="app-edit-buttons">
                <button class="app-edit-button delete-button" id="delete-app-button" style="display: none;">åˆ é™¤</button>
                <button class="app-edit-button cancel-button" id="cancel-app-button">å–æ¶ˆ</button>
                <button class="app-edit-button save-button" id="save-app-button">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ—¶é—´é€‰æ‹©å™¨å¼¹çª— -->
    <div class="time-picker-modal" id="time-picker-modal">
        <div class="time-picker-content">
            <div class="time-columns">
                <div class="time-column" id="hour-column">
                    <!-- å°æ—¶é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="time-column" id="minute-column">
                    <!-- åˆ†é’Ÿé€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="time-picker-buttons">
                <button class="time-picker-button cancel-button" id="cancel-button">å–æ¶ˆ</button>
                <button class="time-picker-button confirm-button" id="confirm-button">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤ç›®æ ‡æ—¶é—´
        let targetHour = 23;
        let targetMinute = 0;

        // æ—¶é—´é€‰æ‹©å™¨å˜é‡
        let selectedHour = targetHour;
        let selectedMinute = targetMinute;

        // DOM å…ƒç´ 
        let modal, hourColumn, minuteColumn, confirmButton, cancelButton, countdownDisplay;

        // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
        function initTimePicker() {
            // ç”Ÿæˆå°æ—¶é€‰é¡¹ (1-24)
            for (let i = 1; i <= 24; i++) {
                const hourItem = document.createElement('div');
                hourItem.className = 'time-item';
                hourItem.textContent = i.toString().padStart(2, '0');
                hourItem.dataset.value = i;
                hourItem.addEventListener('click', () => selectHour(i));
                hourColumn.appendChild(hourItem);
            }

            // ç”Ÿæˆåˆ†é’Ÿé€‰é¡¹ (00 å’Œ 30)
            const minuteValues = [0, 30];
            minuteValues.forEach(min => {
                const minuteItem = document.createElement('div');
                minuteItem.className = 'time-item';
                minuteItem.textContent = min.toString().padStart(2, '0');
                minuteItem.dataset.value = min;
                minuteItem.addEventListener('click', () => selectMinute(min));
                minuteColumn.appendChild(minuteItem);
            });

            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            confirmButton.addEventListener('click', confirmTimeSelection);
            cancelButton.addEventListener('click', closeTimePicker);

            // ç‚¹å‡»å€’è®¡æ—¶æ˜¾ç¤ºæ‰“å¼€æ—¶é—´é€‰æ‹©å™¨
            countdownDisplay.addEventListener('click', openTimePicker);
        }

        // æ‰“å¼€æ—¶é—´é€‰æ‹©å™¨
        function openTimePicker() {
            selectedHour = targetHour;
            selectedMinute = targetMinute;

            // é‡ç½®é€‰ä¸­çŠ¶æ€
            updateTimePickerSelection();

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
        }

        // å…³é—­æ—¶é—´é€‰æ‹©å™¨
        function closeTimePicker() {
            modal.style.display = 'none';
        }

        // é€‰æ‹©å°æ—¶
        function selectHour(hour) {
            selectedHour = hour;
            updateTimePickerSelection();
        }

        // é€‰æ‹©åˆ†é’Ÿ
        function selectMinute(minute) {
            selectedMinute = minute;
            updateTimePickerSelection();
        }

        // æ›´æ–°æ—¶é—´é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
        function updateTimePickerSelection() {
            // æ›´æ–°å°æ—¶é€‰ä¸­çŠ¶æ€
            Array.from(hourColumn.children).forEach(item => {
                if (parseInt(item.dataset.value) === selectedHour) {
                    item.classList.add('selected');
                    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.classList.remove('selected');
                }
            });

            // æ›´æ–°åˆ†é’Ÿé€‰ä¸­çŠ¶æ€
            Array.from(minuteColumn.children).forEach(item => {
                if (parseInt(item.dataset.value) === selectedMinute) {
                    item.classList.add('selected');
                    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // ç¡®è®¤æ—¶é—´é€‰æ‹©
        function confirmTimeSelection() {
            targetHour = selectedHour;
            targetMinute = selectedMinute;
            saveSettings();
            closeTimePicker();
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
        function loadSettings() {
            const savedSettings = localStorage.getItem('bedtimeSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    targetHour = settings.targetHour || 23;
                    targetMinute = settings.targetMinute || 0;
                } catch (e) {
                    console.error("åŠ è½½è®¾ç½®æ—¶å‡ºé”™:", e);
                }
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            try {
                const settings = {
                    targetHour: targetHour,
                    targetMinute: targetMinute
                };

                localStorage.setItem('bedtimeSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("ä¿å­˜è®¾ç½®æ—¶å‡ºé”™:", e);
                alert("ä¿å­˜è®¾ç½®å¤±è´¥: " + e.message);
            }
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown() {
            const now = new Date();

            // è®¾ç½®ç›®æ ‡æ—¶é—´ä¸ºä»Šå¤©çš„ç›®æ ‡æ—¶é—´ç‚¹
            let targetTime = new Date();
            targetTime.setHours(targetHour, targetMinute, 0, 0);

            // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¿‡äº†ä»Šå¤©çš„ç›®æ ‡æ—¶é—´ï¼Œåˆ™ç›®æ ‡æ—¶é—´è®¾ä¸ºæ˜å¤©çš„ç›®æ ‡æ—¶é—´
            if (now >= targetTime) {
                targetTime.setDate(targetTime.getDate() + 1);
            }

            // è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            const timeLeft = targetTime - now;

            // è½¬æ¢ä¸ºå°æ—¶ã€åˆ†é’Ÿå’Œç§’
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');

            // è®¾ç½®æ–‡æ¡£æ ‡é¢˜ï¼Œåªæ˜¾ç¤ºå€’è®¡æ—¶æ•°å­—
            document.title = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // å¤‡å¿˜å½•åŠŸèƒ½
        let memoText;
        let lastSyncTime = null;
        let syncInProgress = false;
        let syncCode = null;
        let lastLocalUpdate = new Date().toISOString();
        let syncCheckInterval = null;

        // åˆå§‹åŒ–å¤‡å¿˜å½•
        async function initMemo() {
            memoText = document.getElementById('memo-text');

            // è·å–åŒæ­¥ç 
            syncCode = getSyncCode();

            // å°è¯•ä»SupabaseåŠ è½½å†…å®¹
            await loadMemoFromSupabase();

            // å¦‚æœæ²¡æœ‰ä»SupabaseåŠ è½½åˆ°å†…å®¹ï¼Œåˆ™å°è¯•ä»æœ¬åœ°åŠ è½½
            if (!memoText.value) {
                const savedMemo = localStorage.getItem('bedtimeMemo');
                if (savedMemo) {
                    memoText.value = savedMemo;
                    // å°†æœ¬åœ°å†…å®¹ä¿å­˜åˆ°Supabase
                    await saveMemoToSupabase(syncCode, savedMemo);
                }
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œè‡ªåŠ¨ä¿å­˜
            memoText.addEventListener('input', saveMemo);

            // æ·»åŠ åŒå‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºåŒæ­¥ç 
            memoText.addEventListener('dblclick', showSyncCode);

            // è®¾ç½®å®šæœŸæ£€æŸ¥æ›´æ–°çš„å®šæ—¶å™¨
            syncCheckInterval = setInterval(checkForMemoUpdates, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // ä¿å­˜å¤‡å¿˜å½•å†…å®¹
        async function saveMemo() {
            const content = memoText.value;

            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('bedtimeMemo', content);
            lastLocalUpdate = new Date().toISOString();
            localStorage.setItem('bedtimeLastUpdate', lastLocalUpdate);

            // ä¿å­˜åˆ°Supabase
            if (!syncInProgress) {
                syncInProgress = true;
                try {
                    console.log('æ­£åœ¨ä¿å­˜åˆ°Supabaseï¼ŒåŒæ­¥ç :', syncCode);
                    const result = await saveMemoToSupabase(syncCode, content);
                    lastSyncTime = new Date();
                    console.log('ä¿å­˜åˆ°SupabaseæˆåŠŸ:', result);
                } catch (error) {
                    console.error('ä¿å­˜åˆ°Supabaseå¤±è´¥:', error);
                } finally {
                    syncInProgress = false;
                }
            }
        }

        // ä»SupabaseåŠ è½½å¤‡å¿˜å½•å†…å®¹
        async function loadMemoFromSupabase() {
            try {
                const data = await fetchMemoFromSupabase(syncCode);
                if (data && data.content) {
                    // æ¯”è¾ƒæœ¬åœ°å’Œè¿œç¨‹çš„æ›´æ–°æ—¶é—´
                    const localLastUpdate = localStorage.getItem('bedtimeLastUpdate');

                    if (!localLastUpdate || new Date(data.updated_at) > new Date(localLastUpdate)) {
                        memoText.value = data.content;
                        localStorage.setItem('bedtimeMemo', data.content);
                        localStorage.setItem('bedtimeLastUpdate', data.updated_at);
                        lastLocalUpdate = data.updated_at;
                        console.log('ä»SupabaseåŠ è½½äº†æ›´æ–°çš„å†…å®¹');
                    }

                    lastSyncTime = new Date();
                    return true;
                }
            } catch (error) {
                console.error('ä»SupabaseåŠ è½½å¤±è´¥:', error);
            }
            return false;
        }

        // å®šæœŸæ£€æŸ¥Supabaseæ˜¯å¦æœ‰æ›´æ–°
        async function checkForMemoUpdates() {
            if (syncInProgress) return;

            try {
                syncInProgress = true;
                const hasUpdates = await checkForUpdates(syncCode, lastLocalUpdate);

                if (hasUpdates) {
                    console.log('æ£€æµ‹åˆ°Supabaseæœ‰æ›´æ–°ï¼Œæ­£åœ¨åŠ è½½...');
                    await loadMemoFromSupabase();
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
            } finally {
                syncInProgress = false;
            }
        }

        // ç”ŸæˆåŒæ­¥ç 
        function generateSyncCode() {
            const adjectives = ['å¿«ä¹', 'èªæ˜', 'å‹‡æ•¢', 'æ¸©æŸ”', 'æ´»æ³¼', 'å®‰é™', 'æ˜äº®', 'æ•æ·', 'å‹å¥½', 'å–„è‰¯'];
            const nouns = ['çŒ«å’ª', 'ç‹—ç‹—', 'å…”å­', 'ç†ŠçŒ«', 'è€è™', 'ç‹®å­', 'å¤§è±¡', 'é•¿é¢ˆé¹¿', 'æµ·è±š', 'ä¼é¹…'];

            const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
            const randomNumber = Math.floor(Math.random() * 100);

            return `${randomAdjective}-${randomNoun}-${randomNumber}`;
        }

        // è·å–åŒæ­¥ç 
        function getSyncCode() {
            let code = localStorage.getItem('bedtimeSyncCode');
            if (!code) {
                code = generateSyncCode();
                localStorage.setItem('bedtimeSyncCode', code);
            }
            return code;
        }

        // ä»Supabaseè·å–å¤‡å¿˜å½•å†…å®¹
        async function fetchMemoFromSupabase(syncCode) {
            const { data, error } = await supabase
                .from('memo_sync')
                .select('content, updated_at')
                .eq('sync_code', syncCode)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 æ˜¯"æ²¡æœ‰æ‰¾åˆ°ç»“æœ"çš„é”™è¯¯
                console.error('ä»Supabaseè·å–å¤‡å¿˜å½•æ—¶å‡ºé”™:', error);
                return null;
            }

            return data;
        }

        // ä¿å­˜å¤‡å¿˜å½•å†…å®¹åˆ°Supabase
        async function saveMemoToSupabase(syncCode, content) {
            const { error } = await supabase
                .from('memo_sync')
                .upsert({
                    sync_code: syncCode,
                    content: content,
                    updated_at: new Date().toISOString()
                });

            if (error) {
                console.error('ä¿å­˜å¤‡å¿˜å½•åˆ°Supabaseæ—¶å‡ºé”™:', error);
                return false;
            }

            return true;
        }

        // æ£€æŸ¥Supabaseæ˜¯å¦æœ‰æ›´æ–°
        async function checkForUpdates(syncCode, localUpdatedAt) {
            const { data, error } = await supabase
                .from('memo_sync')
                .select('updated_at')
                .eq('sync_code', syncCode)
                .single();

            if (error) {
                if (error.code === 'PGRST116') { // æ²¡æœ‰æ‰¾åˆ°ç»“æœ
                    return false;
                }
                console.error('æ£€æŸ¥æ›´æ–°æ—¶å‡ºé”™:', error);
                return false;
            }

            if (!data) return false;

            // æ¯”è¾ƒæ—¶é—´æˆ³
            const remoteUpdatedAt = new Date(data.updated_at);
            const localDate = new Date(localUpdatedAt);

            return remoteUpdatedAt > localDate;
        }

        // æ˜¾ç¤ºåŒæ­¥ç 
        function showSyncCode() {
            const code = getSyncCode();
            alert(`æ‚¨çš„åŒæ­¥ç æ˜¯: ${code}\n\nè¯·è®°ä½è¿™ä¸ªåŒæ­¥ç ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨å®ƒæ¥åŒæ­¥å¤‡å¿˜å½•å†…å®¹ã€‚`);
        }

        // è®¾ç½®åŒæ­¥ç ï¼ˆç”¨äºåœ¨å…¶ä»–è®¾å¤‡ä¸Šè¾“å…¥åŒæ­¥ç ï¼‰
        function setSyncCode(newCode) {
            if (newCode && newCode.trim() !== '') {
                localStorage.setItem('bedtimeSyncCode', newCode.trim());
                syncCode = newCode.trim();
                loadMemoFromSupabase(); // ç«‹å³å°è¯•åŠ è½½
                return true;
            }
            return false;
        }

        // åº”ç”¨æ¡Œé¢åŠŸèƒ½
        let appDrawer, appGrid, addAppButton;
        let appEditModal, appNameInput, appUrlInput, appIconInput;
        let saveAppButton, cancelAppButton, deleteAppButton, appEditTitle;
        let currentEditingAppId = null;
        let apps = [];

        // åˆå§‹åŒ–åº”ç”¨æ¡Œé¢
        function initAppDrawer() {
            appDrawer = document.getElementById('app-drawer');
            appGrid = document.getElementById('app-grid');
            addAppButton = document.getElementById('add-app');

            // ä¸å†ä¸ºæ•´ä¸ªæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œåªåœ¨å›¾æ ‡ä¸Šæ·»åŠ 

            // åŠ è½½ä¿å­˜çš„åº”ç”¨
            loadApps();
            renderApps();

            // æ·»åŠ æ»‘åŠ¨æ‰‹åŠ¿æ£€æµ‹
            initSwipeDetection();
        }

        // åˆå§‹åŒ–åº”ç”¨ç¼–è¾‘å¼¹çª—
        function initAppEditModal() {
            appEditModal = document.getElementById('app-edit-modal');
            appNameInput = document.getElementById('app-name-input');
            appUrlInput = document.getElementById('app-url-input');
            appIconInput = document.getElementById('app-icon-input');
            saveAppButton = document.getElementById('save-app-button');
            cancelAppButton = document.getElementById('cancel-app-button');
            deleteAppButton = document.getElementById('delete-app-button');
            appEditTitle = document.getElementById('app-edit-title');

            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            saveAppButton.addEventListener('click', saveApp);
            cancelAppButton.addEventListener('click', closeAppEditModal);
            deleteAppButton.addEventListener('click', deleteApp);
        }

        // æ‰“å¼€åº”ç”¨ç¼–è¾‘å¼¹çª—
        function openAppEditModal(appId = null) {
            currentEditingAppId = appId;

            if (appId) {
                // ç¼–è¾‘ç°æœ‰åº”ç”¨
                const app = apps.find(a => a.id === appId);
                if (app) {
                    appNameInput.value = app.name;
                    appUrlInput.value = app.url;
                    appIconInput.value = app.icon || '';
                    appEditTitle.textContent = 'ç¼–è¾‘åº”ç”¨';
                    deleteAppButton.style.display = 'block';
                }
            } else {
                // æ·»åŠ æ–°åº”ç”¨
                appNameInput.value = '';
                appUrlInput.value = '';
                appIconInput.value = '';
                appEditTitle.textContent = 'æ·»åŠ åº”ç”¨';
                deleteAppButton.style.display = 'none';
            }

            appEditModal.style.display = 'flex';
        }

        // å…³é—­åº”ç”¨ç¼–è¾‘å¼¹çª—
        function closeAppEditModal() {
            appEditModal.style.display = 'none';
            currentEditingAppId = null;
        }

        // ä¿å­˜åº”ç”¨
        function saveApp() {
            const name = appNameInput.value.trim();
            const url = appUrlInput.value.trim();
            const icon = appIconInput.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥åº”ç”¨åç§°');
                return;
            }

            if (!url) {
                alert('è¯·è¾“å…¥ç½‘å€');
                return;
            }

            // éªŒè¯URLæ ¼å¼
            try {
                new URL(url);
            } catch (e) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€ï¼ŒåŒ…å«http://æˆ–https://');
                return;
            }

            if (currentEditingAppId) {
                // æ›´æ–°ç°æœ‰åº”ç”¨
                const index = apps.findIndex(a => a.id === currentEditingAppId);
                if (index !== -1) {
                    apps[index] = {
                        ...apps[index],
                        name,
                        url,
                        icon
                    };
                }
            } else {
                // æ·»åŠ æ–°åº”ç”¨
                const newApp = {
                    id: Date.now().toString(),
                    name,
                    url,
                    icon,
                    createdAt: new Date().toISOString()
                };
                apps.push(newApp);
            }

            // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
            saveApps();
            renderApps();
            closeAppEditModal();
        }

        // åˆ é™¤åº”ç”¨
        function deleteApp() {
            if (!currentEditingAppId) return;

            const confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåº”ç”¨å—ï¼Ÿ');
            if (!confirmed) return;

            apps = apps.filter(a => a.id !== currentEditingAppId);
            saveApps();
            renderApps();
            closeAppEditModal();
        }

        // å…¨å±€å˜é‡ï¼Œç”¨äºè·Ÿè¸ªæ˜¯å¦æ­£åœ¨æ‹–åŠ¨
        let isGlobalDragging = false;
        let touchMoveDistance = 0;

        // æ¸²æŸ“åº”ç”¨åˆ—è¡¨
        function renderApps() {
            // æ¸…é™¤ç°æœ‰åº”ç”¨ï¼ˆä¿ç•™æ·»åŠ æŒ‰é’®ï¼‰
            while (appGrid.firstChild && appGrid.firstChild.id !== 'add-app') {
                appGrid.removeChild(appGrid.firstChild);
            }

            // æ·»åŠ åº”ç”¨å›¾æ ‡
            apps.forEach(app => {
                const appItem = document.createElement('div');
                appItem.className = 'app-item';
                appItem.dataset.id = app.id;

                const appIcon = document.createElement('div');
                appIcon.className = 'app-icon';
                appIcon.textContent = app.icon || app.name.charAt(0).toUpperCase();

                const appName = document.createElement('div');
                appName.className = 'app-name';
                appName.textContent = app.name;

                appItem.appendChild(appIcon);
                appItem.appendChild(appName);

                // ç‚¹å‡»æ‰“å¼€ç½‘å€ - ä½¿ç”¨mouseup/touchendè€Œä¸æ˜¯click
                let appTouchStartX = 0;
                let appTouchStartY = 0;
                let appTouchMoved = false;

                // ä½¿ç”¨pointeräº‹ä»¶å®ç°é•¿æŒ‰åŠŸèƒ½
                let longPressTimer;
                let isPointerDown = false;
                let pointerStartX = 0;
                let pointerStartY = 0;
                let hasMoved = false;
                const LONG_PRESS_DURATION = 500; // é•¿æŒ‰æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰

                // æŒ‡é’ˆæŒ‰ä¸‹äº‹ä»¶
                appIcon.addEventListener('pointerdown', (e) => {
                    // æŒ‡é’ˆæŒ‰ä¸‹
                    isPointerDown = true;
                    hasMoved = false;
                    pointerStartX = e.clientX;
                    pointerStartY = e.clientY;

                    // æ·»åŠ è§†è§‰åé¦ˆ
                    setTimeout(() => {
                        if (isPointerDown && !hasMoved) {
                            // æ·»åŠ è§†è§‰åé¦ˆ
                            appIcon.classList.add('long-press');
                        }
                    }, 100);

                    // è®¾ç½®é•¿æŒ‰è®¡æ—¶å™¨
                    longPressTimer = setTimeout(() => {
                        if (isPointerDown && !hasMoved) {
                            // æ£€æµ‹åˆ°é•¿æŒ‰

                            // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒï¼‰
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                                // éœ‡åŠ¨åé¦ˆå·²è§¦å‘
                            }

                            // æ‰“å¼€ç¼–è¾‘æ¨¡å¼
                            openAppEditModal(app.id);

                            // é˜²æ­¢åç»­è§¦å‘ç‚¹å‡»äº‹ä»¶
                            hasMoved = true;
                        }
                    }, LONG_PRESS_DURATION);

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
                    e.stopPropagation();
                    e.preventDefault();
                });

                // æŒ‡é’ˆç§»åŠ¨äº‹ä»¶
                appIcon.addEventListener('pointermove', (e) => {
                    if (!isPointerDown) return;

                    const moveX = Math.abs(e.clientX - pointerStartX);
                    const moveY = Math.abs(e.clientY - pointerStartY);

                    // å¦‚æœç§»åŠ¨è¶…è¿‡10pxï¼Œæ ‡è®°ä¸ºå·²ç§»åŠ¨
                    if (moveX > 10 || moveY > 10) {
                        // æŒ‡é’ˆç§»åŠ¨è¶…è¿‡é˜ˆå€¼
                        hasMoved = true;
                        clearTimeout(longPressTimer);
                        appIcon.classList.remove('long-press'); // ç§»é™¤é•¿æŒ‰æ•ˆæœ
                    }

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                // æŒ‡é’ˆé‡Šæ”¾äº‹ä»¶
                appIcon.addEventListener('pointerup', (e) => {
                    // æŒ‡é’ˆé‡Šæ”¾

                    // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                    clearTimeout(longPressTimer);

                    // ç§»é™¤è§†è§‰åé¦ˆ
                    appIcon.classList.remove('long-press');

                    // å¦‚æœæ²¡æœ‰ç§»åŠ¨ä¸”ä¸æ˜¯å…¨å±€æ‹–åŠ¨çŠ¶æ€ï¼Œåˆ™è§†ä¸ºç‚¹å‡»
                    if (!hasMoved && !isGlobalDragging) {
                        // è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œæ‰“å¼€ç½‘å€
                        // æ­£å¸¸ç‚¹å‡»æ‰“å¼€ç½‘å€
                        window.open(app.url, '_blank');
                    }

                    // é‡ç½®çŠ¶æ€
                    isPointerDown = false;

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                // æŒ‡é’ˆç¦»å¼€äº‹ä»¶
                appIcon.addEventListener('pointerleave', (e) => {
                    // æŒ‡é’ˆç¦»å¼€

                    // æ¸…é™¤é•¿æŒ‰è®¡æ—¶å™¨
                    clearTimeout(longPressTimer);

                    // ç§»é™¤è§†è§‰åé¦ˆ
                    appIcon.classList.remove('long-press');

                    // é‡ç½®çŠ¶æ€
                    isPointerDown = false;

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                // æ·»åŠ contextmenuäº‹ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                appIcon.addEventListener('contextmenu', (e) => {
                    // æ£€æµ‹åˆ°contextmenuäº‹ä»¶ï¼ˆé•¿æŒ‰ï¼‰
                    e.preventDefault();

                    // æ‰“å¼€ç¼–è¾‘æ¨¡å¼
                    openAppEditModal(app.id);

                    return false;
                });

                // é¼ æ ‡äº‹ä»¶ - ä½¿ç”¨mousedown/mouseupè€Œä¸æ˜¯click
                let appMouseStartX = 0;
                let appMouseStartY = 0;
                let appMouseMoved = false;

                appIcon.addEventListener('mousedown', (e) => {
                    appMouseStartX = e.clientX;
                    appMouseStartY = e.clientY;
                    appMouseMoved = false;

                    // ç¼–è¾‘æ¨¡å¼ï¼ˆæŒ‰ä½Shiftæˆ–Ctrlé”®ç‚¹å‡»ï¼‰
                    if (e.shiftKey || e.ctrlKey) {
                        openAppEditModal(app.id);
                    }

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                appIcon.addEventListener('mousemove', (e) => {
                    if (e.buttons === 1) { // é¼ æ ‡å·¦é”®æŒ‰ä¸‹
                        const moveX = Math.abs(e.clientX - appMouseStartX);
                        const moveY = Math.abs(e.clientY - appMouseStartY);

                        // å¦‚æœç§»åŠ¨è¶…è¿‡10pxï¼Œæ ‡è®°ä¸ºå·²ç§»åŠ¨
                        if (moveX > 10 || moveY > 10) {
                            appMouseMoved = true;
                        }
                    }

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                appIcon.addEventListener('mouseup', (e) => {
                    // åªæœ‰åœ¨æ²¡æœ‰ç§»åŠ¨ä¸”ä¸æ˜¯å…¨å±€æ‹–åŠ¨çŠ¶æ€æ—¶æ‰è§¦å‘ç‚¹å‡»
                    if (!appMouseMoved && !isGlobalDragging && !e.shiftKey && !e.ctrlKey) {
                        // æ­£å¸¸ç‚¹å‡»æ‰“å¼€ç½‘å€
                        window.open(app.url, '_blank');
                    }

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    e.stopPropagation();
                });

                // å°†åº”ç”¨æ·»åŠ åˆ°ç½‘æ ¼ä¸­ï¼ˆåœ¨æ·»åŠ æŒ‰é’®ä¹‹å‰ï¼‰
                appGrid.insertBefore(appItem, addAppButton);
            });

            // ä¸ºæ·»åŠ åº”ç”¨æŒ‰é’®æ·»åŠ ç±»ä¼¼çš„å¤„ç†
            let addAppTouchStartX = 0;
            let addAppTouchStartY = 0;
            let addAppTouchMoved = false;

            // ç§»é™¤ç°æœ‰çš„ç‚¹å‡»äº‹ä»¶
            addAppButton.removeEventListener('click', () => openAppEditModal());

            // è·å–æ·»åŠ æŒ‰é’®çš„å›¾æ ‡å…ƒç´ 
            const addAppIcon = addAppButton.querySelector('.add-app-button');

            // ä½¿ç”¨pointeräº‹ä»¶å®ç°ç‚¹å‡»åŠŸèƒ½
            let addLongPressTimer;
            let addIsPointerDown = false;
            let addPointerStartX = 0;
            let addPointerStartY = 0;
            let addHasMoved = false;

            // æŒ‡é’ˆæŒ‰ä¸‹äº‹ä»¶
            addAppIcon.addEventListener('pointerdown', (e) => {
                addIsPointerDown = true;
                addHasMoved = false;
                addPointerStartX = e.clientX;
                addPointerStartY = e.clientY;

                // æ·»åŠ è§†è§‰åé¦ˆ
                setTimeout(() => {
                    if (addIsPointerDown && !addHasMoved) {
                        addAppIcon.classList.add('long-press');
                    }
                }, 100);

                // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
                e.stopPropagation();
                e.preventDefault();
            });

            // æŒ‡é’ˆç§»åŠ¨äº‹ä»¶
            addAppIcon.addEventListener('pointermove', (e) => {
                if (!addIsPointerDown) return;

                const moveX = Math.abs(e.clientX - addPointerStartX);
                const moveY = Math.abs(e.clientY - addPointerStartY);

                // å¦‚æœç§»åŠ¨è¶…è¿‡10pxï¼Œæ ‡è®°ä¸ºå·²ç§»åŠ¨
                if (moveX > 10 || moveY > 10) {
                    addHasMoved = true;
                    addAppIcon.classList.remove('long-press'); // ç§»é™¤é•¿æŒ‰æ•ˆæœ
                }

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });

            // æŒ‡é’ˆé‡Šæ”¾äº‹ä»¶
            addAppIcon.addEventListener('pointerup', (e) => {
                // ç§»é™¤è§†è§‰åé¦ˆ
                addAppIcon.classList.remove('long-press');

                // å¦‚æœæ²¡æœ‰ç§»åŠ¨ä¸”ä¸æ˜¯å…¨å±€æ‹–åŠ¨çŠ¶æ€ï¼Œåˆ™è§†ä¸ºç‚¹å‡»
                if (!addHasMoved && !isGlobalDragging) {
                    openAppEditModal();
                }

                // é‡ç½®çŠ¶æ€
                addIsPointerDown = false;

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });

            // æŒ‡é’ˆç¦»å¼€äº‹ä»¶
            addAppIcon.addEventListener('pointerleave', (e) => {
                // ç§»é™¤è§†è§‰åé¦ˆ
                addAppIcon.classList.remove('long-press');

                // é‡ç½®çŠ¶æ€
                addIsPointerDown = false;

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });

            // æ·»åŠ contextmenuäº‹ä»¶ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            addAppIcon.addEventListener('contextmenu', (e) => {
                e.preventDefault();

                // æ‰“å¼€ç¼–è¾‘æ¨¡å¼
                openAppEditModal();

                return false;
            });

            // æ·»åŠ æ–°çš„é¼ æ ‡äº‹ä»¶ - åªåœ¨å›¾æ ‡ä¸Šæ·»åŠ äº‹ä»¶
            let addAppMouseStartX = 0;
            let addAppMouseStartY = 0;
            let addAppMouseMoved = false;

            addAppIcon.addEventListener('mousedown', (e) => {
                addAppMouseStartX = e.clientX;
                addAppMouseStartY = e.clientY;
                addAppMouseMoved = false;

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });

            addAppIcon.addEventListener('mousemove', (e) => {
                if (e.buttons === 1) {
                    const moveX = Math.abs(e.clientX - addAppMouseStartX);
                    const moveY = Math.abs(e.clientY - addAppMouseStartY);

                    if (moveX > 10 || moveY > 10) {
                        addAppMouseMoved = true;
                    }
                }

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });

            addAppIcon.addEventListener('mouseup', (e) => {
                if (!addAppMouseMoved && !isGlobalDragging) {
                    openAppEditModal();
                }

                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.stopPropagation();
            });
        }

        // é»˜è®¤åº”ç”¨é…ç½® - åœ¨è¿™é‡Œé…ç½®æ‚¨æƒ³è¦çš„é»˜è®¤åº”ç”¨
        const defaultApps = [
            {
                id: 'default-1',
                name: 'æ–‡æœ¬å·¥å…·',
                url: 'https://xuperbad.github.io/mdSplitter/md_splitter.html',
                icon: 'MD',
                isDefault: true
            },
            // æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šé»˜è®¤åº”ç”¨
        ];

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½åº”ç”¨
        function loadApps() {
            const savedApps = localStorage.getItem('bedtimeApps');
            let loadedApps = [];

            if (savedApps) {
                try {
                    loadedApps = JSON.parse(savedApps);

                    // ç¡®ä¿æ‰€æœ‰é»˜è®¤åº”ç”¨éƒ½å­˜åœ¨
                    ensureDefaultApps(loadedApps);

                    // æ›´æ–°åº”ç”¨åˆ—è¡¨
                    apps = loadedApps;
                } catch (e) {
                    console.error("åŠ è½½åº”ç”¨æ—¶å‡ºé”™:", e);
                    // å¦‚æœåŠ è½½å‡ºé”™ï¼Œä½¿ç”¨é»˜è®¤åº”ç”¨
                    apps = [...defaultApps];
                    saveApps();
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åº”ç”¨ï¼Œä½¿ç”¨é»˜è®¤åº”ç”¨
                apps = [...defaultApps];
                saveApps();
            }
        }

        // ç¡®ä¿é»˜è®¤åº”ç”¨å­˜åœ¨
        function ensureDefaultApps(loadedApps) {
            // æ£€æŸ¥æ¯ä¸ªé»˜è®¤åº”ç”¨æ˜¯å¦å­˜åœ¨
            defaultApps.forEach(defaultApp => {
                const exists = loadedApps.some(app =>
                    app.url === defaultApp.url || app.id === defaultApp.id
                );

                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°åŠ è½½çš„åº”ç”¨åˆ—è¡¨ä¸­
                if (!exists) {
                    loadedApps.push({
                        ...defaultApp,
                        createdAt: new Date().toISOString()
                    });
                }
            });
        }

        // ä¿å­˜åº”ç”¨åˆ°æœ¬åœ°å­˜å‚¨
        function saveApps() {
            try {
                localStorage.setItem('bedtimeApps', JSON.stringify(apps));
            } catch (e) {
                console.error("ä¿å­˜åº”ç”¨æ—¶å‡ºé”™:", e);
                alert("ä¿å­˜åº”ç”¨å¤±è´¥: " + e.message);
            }
        }

        // è·å–ä¸»å®¹å™¨å…ƒç´ 
        let mainContainer;

        // æ‰“å¼€åº”ç”¨æŠ½å±‰
        function openAppDrawer() {
            // ç§»é™¤å†…è”æ ·å¼ï¼Œä½¿ç”¨ç±»æ¥æ§åˆ¶
            appDrawer.style.transform = '';
            appDrawer.style.opacity = '';
            mainContainer.style.transform = '';
            mainContainer.style.opacity = '';

            // æ·»åŠ æ¿€æ´»ç±»
            appDrawer.classList.add('active');
            mainContainer.classList.add('drawer-active');
        }

        // å…³é—­åº”ç”¨æŠ½å±‰
        function closeAppDrawer() {
            // ç§»é™¤å†…è”æ ·å¼ï¼Œä½¿ç”¨ç±»æ¥æ§åˆ¶
            appDrawer.style.transform = '';
            appDrawer.style.opacity = '';
            mainContainer.style.transform = '';
            mainContainer.style.opacity = '';

            // ç§»é™¤æ¿€æ´»ç±»
            appDrawer.classList.remove('active');
            mainContainer.classList.remove('drawer-active');
        }

        // åº”ç”¨æŠ½å±‰å¯ä»¥é€šè¿‡ä»å³å‘å·¦æ»‘åŠ¨å±å¹•æ‰“å¼€

        // åˆå§‹åŒ–æ»‘åŠ¨æ£€æµ‹
        function initSwipeDetection() {
            let touchStartX = 0;
            let currentTouchX = 0;
            let isDrawerOpen = false;
            let screenWidth = window.innerWidth;

            // è§¦æ‘¸äº‹ä»¶å¤„ç†
            document.body.addEventListener('touchstart', (e) => {
                // å¦‚æœæ˜¯ç‚¹å‡»æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œä¸å¤„ç†
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                touchStartX = e.touches[0].clientX;
                currentTouchX = touchStartX;
                isDrawerOpen = appDrawer.classList.contains('active');

                // æ·»åŠ æ‹–åŠ¨çŠ¶æ€ç±»
                appDrawer.classList.add('dragging');
                mainContainer.classList.add('dragging');

                // é‡ç½®ç§»åŠ¨è·ç¦»
                touchMoveDistance = 0;
            }, { passive: false });

            document.body.addEventListener('touchmove', (e) => {
                // å¦‚æœæ˜¯ç‚¹å‡»æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œä¸å¤„ç†
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                currentTouchX = e.touches[0].clientX;
                const deltaX = currentTouchX - touchStartX;

                // è®¡ç®—æ€»ç§»åŠ¨è·ç¦»ï¼ˆç»å¯¹å€¼ï¼‰
                touchMoveDistance = Math.abs(deltaX);

                // è®¾ç½®å…¨å±€æ‹–åŠ¨çŠ¶æ€
                if (touchMoveDistance > 10) {
                    isGlobalDragging = true;
                }

                // è®¡ç®—ç§»åŠ¨ç™¾åˆ†æ¯”
                let percent;

                if (isDrawerOpen) {
                    // å¦‚æœæŠ½å±‰å·²æ‰“å¼€ï¼Œåˆ™ä»å·¦å‘å³æ‹–åŠ¨æ—¶ï¼Œç™¾åˆ†æ¯”ä»100%å‡å°‘
                    percent = Math.max(0, 100 - (deltaX / screenWidth * 100));
                } else {
                    // å¦‚æœæŠ½å±‰å…³é—­ï¼Œåˆ™ä»å³å‘å·¦æ‹–åŠ¨æ—¶ï¼Œç™¾åˆ†æ¯”ä»0å¢åŠ 
                    percent = Math.max(0, Math.min(100, -deltaX / screenWidth * 100));
                }

                // åº”ç”¨å®æ—¶å˜æ¢
                updateDrawerPosition(percent);

                // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
                e.preventDefault();
            }, { passive: false });

            document.body.addEventListener('touchend', (e) => {
                const deltaX = currentTouchX - touchStartX;

                // ç§»é™¤æ‹–åŠ¨çŠ¶æ€ç±»
                appDrawer.classList.remove('dragging');
                mainContainer.classList.remove('dragging');

                // æ ¹æ®æ‹–åŠ¨è·ç¦»å’Œæ–¹å‘å†³å®šæ˜¯æ‰“å¼€è¿˜æ˜¯å…³é—­æŠ½å±‰
                if (isDrawerOpen) {
                    // å¦‚æœæŠ½å±‰å·²æ‰“å¼€ï¼Œå‘å³æ‹–åŠ¨è¶…è¿‡å±å¹•å®½åº¦çš„20%åˆ™å…³é—­
                    if (deltaX > screenWidth * 0.2) {
                        closeAppDrawer();
                    } else {
                        openAppDrawer(); // æ¢å¤æ‰“å¼€çŠ¶æ€
                    }
                } else {
                    // å¦‚æœæŠ½å±‰å…³é—­ï¼Œå‘å·¦æ‹–åŠ¨è¶…è¿‡å±å¹•å®½åº¦çš„20%åˆ™æ‰“å¼€
                    if (deltaX < -screenWidth * 0.2) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer(); // æ¢å¤å…³é—­çŠ¶æ€
                    }
                }

                // å»¶è¿Ÿé‡ç½®å…¨å±€æ‹–åŠ¨çŠ¶æ€ï¼Œç»™ç‚¹å‡»äº‹ä»¶å¤„ç†ç•™å‡ºæ—¶é—´
                setTimeout(() => {
                    isGlobalDragging = false;
                }, 50);
            }, { passive: true });

            // é¼ æ ‡äº‹ä»¶å¤„ç†ï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰
            let mouseStartX = 0;
            let currentMouseX = 0;
            let isMouseDown = false;

            document.body.addEventListener('mousedown', (e) => {
                // å¦‚æœæ˜¯ç‚¹å‡»æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œä¸å¤„ç†
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                isMouseDown = true;
                mouseStartX = e.clientX;
                currentMouseX = mouseStartX;
                isDrawerOpen = appDrawer.classList.contains('active');

                // æ·»åŠ æ‹–åŠ¨çŠ¶æ€ç±»
                appDrawer.classList.add('dragging');
                mainContainer.classList.add('dragging');

                // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢æ–‡æœ¬é€‰æ‹©
                e.preventDefault();
            });

            document.body.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;

                currentMouseX = e.clientX;
                const deltaX = currentMouseX - mouseStartX;

                // è®¡ç®—ç§»åŠ¨ç™¾åˆ†æ¯”
                let percent;

                if (isDrawerOpen) {
                    // å¦‚æœæŠ½å±‰å·²æ‰“å¼€ï¼Œåˆ™ä»å·¦å‘å³æ‹–åŠ¨æ—¶ï¼Œç™¾åˆ†æ¯”ä»100%å‡å°‘
                    percent = Math.max(0, 100 - (deltaX / screenWidth * 100));
                } else {
                    // å¦‚æœæŠ½å±‰å…³é—­ï¼Œåˆ™ä»å³å‘å·¦æ‹–åŠ¨æ—¶ï¼Œç™¾åˆ†æ¯”ä»0å¢åŠ 
                    percent = Math.max(0, Math.min(100, -deltaX / screenWidth * 100));
                }

                // åº”ç”¨å®æ—¶å˜æ¢
                updateDrawerPosition(percent);

                // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢æ–‡æœ¬é€‰æ‹©
                e.preventDefault();
            });

            document.body.addEventListener('mouseup', (e) => {
                if (!isMouseDown) return;

                const deltaX = currentMouseX - mouseStartX;
                const mouseMoveDistance = Math.abs(deltaX);

                // è®¾ç½®å…¨å±€æ‹–åŠ¨çŠ¶æ€
                if (mouseMoveDistance > 10) {
                    isGlobalDragging = true;
                }

                // ç§»é™¤æ‹–åŠ¨çŠ¶æ€ç±»
                appDrawer.classList.remove('dragging');
                mainContainer.classList.remove('dragging');

                // æ ¹æ®æ‹–åŠ¨è·ç¦»å’Œæ–¹å‘å†³å®šæ˜¯æ‰“å¼€è¿˜æ˜¯å…³é—­æŠ½å±‰
                if (isDrawerOpen) {
                    // å¦‚æœæŠ½å±‰å·²æ‰“å¼€ï¼Œå‘å³æ‹–åŠ¨è¶…è¿‡å±å¹•å®½åº¦çš„20%åˆ™å…³é—­
                    if (deltaX > screenWidth * 0.2) {
                        closeAppDrawer();
                    } else {
                        openAppDrawer(); // æ¢å¤æ‰“å¼€çŠ¶æ€
                    }
                } else {
                    // å¦‚æœæŠ½å±‰å…³é—­ï¼Œå‘å·¦æ‹–åŠ¨è¶…è¿‡å±å¹•å®½åº¦çš„20%åˆ™æ‰“å¼€
                    if (deltaX < -screenWidth * 0.2) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer(); // æ¢å¤å…³é—­çŠ¶æ€
                    }
                }

                // é‡ç½®çŠ¶æ€
                isMouseDown = false;

                // å»¶è¿Ÿé‡ç½®å…¨å±€æ‹–åŠ¨çŠ¶æ€ï¼Œç»™ç‚¹å‡»äº‹ä»¶å¤„ç†ç•™å‡ºæ—¶é—´
                setTimeout(() => {
                    isGlobalDragging = false;
                }, 50);
            });

            // å¦‚æœé¼ æ ‡ç¦»å¼€é¡µé¢ï¼Œä¹Ÿé‡ç½®çŠ¶æ€
            document.body.addEventListener('mouseleave', () => {
                if (isMouseDown) {
                    // ç§»é™¤æ‹–åŠ¨çŠ¶æ€ç±»
                    appDrawer.classList.remove('dragging');
                    mainContainer.classList.remove('dragging');

                    // æ¢å¤åˆ°åŸå§‹çŠ¶æ€
                    if (isDrawerOpen) {
                        openAppDrawer();
                    } else {
                        closeAppDrawer();
                    }

                    isMouseDown = false;

                    // é‡ç½®å…¨å±€æ‹–åŠ¨çŠ¶æ€
                    isGlobalDragging = false;
                }
            });

            // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°å±å¹•å®½åº¦
            window.addEventListener('resize', () => {
                screenWidth = window.innerWidth;
            });
        }

        // æ ¹æ®ç™¾åˆ†æ¯”æ›´æ–°æŠ½å±‰ä½ç½®
        function updateDrawerPosition(percent) {
            // æŠ½å±‰ä½ç½®ï¼šä»å³ä¾§ç§»åŠ¨åˆ°å·¦ä¾§ï¼Œç™¾åˆ†æ¯”ä»0åˆ°100
            const drawerTransform = `translateX(${-percent}%)`;
            appDrawer.style.transform = drawerTransform;

            // æŠ½å±‰é€æ˜åº¦ï¼šä»0åˆ°1ï¼Œä¸ç™¾åˆ†æ¯”æˆæ­£æ¯”
            const drawerOpacity = percent / 100;
            appDrawer.style.opacity = drawerOpacity;

            // ä¸»å®¹å™¨ä½ç½®ï¼šå‘å·¦ç§»åŠ¨ï¼Œæœ€å¤š30%
            const containerTransform = `translateX(${-(percent * 0.3)}%)`;
            mainContainer.style.transform = containerTransform;

            // ä¸»å®¹å™¨é€æ˜åº¦ï¼šä»1é™åˆ°0.3ï¼Œä¸ç™¾åˆ†æ¯”æˆåæ¯”
            const containerOpacity = 1 - (percent * 0.7 / 100);
            mainContainer.style.opacity = containerOpacity;
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+S: è®¾ç½®åŒæ­¥ç 
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                const newCode = prompt('è¯·è¾“å…¥åŒæ­¥ç ä»¥ä»å…¶ä»–è®¾å¤‡åŒæ­¥å¤‡å¿˜å½•å†…å®¹:');
                if (newCode) {
                    if (setSyncCode(newCode)) {
                        alert(`åŒæ­¥ç å·²è®¾ç½®ä¸º: ${newCode}\næ­£åœ¨å°è¯•åŒæ­¥...`);
                    } else {
                        alert('åŒæ­¥ç æ— æ•ˆï¼Œè¯·é‡è¯•ã€‚');
                    }
                }
            }
        });

        // å£°æ˜å…¨å±€å˜é‡
        let supabase;
        const supabaseUrl = 'https://iohhwiviuugoawsmxjyy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvaGh3aXZpdXVnb2F3c214anl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NzQ5NzYsImV4cCI6MjA2MTE1MDk3Nn0.4KTa7AqBVgurN30gy3han9WTxD2x_7TsMDbdEDxVmSQ';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
            try {
                // ç¡®ä¿supabaseå¯¹è±¡å­˜åœ¨
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                } else {
                    console.error('Supabaseå¯¹è±¡ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è„šæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½');
                }
            } catch (error) {
                console.error('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
            }

            // åˆå§‹åŒ–DOMå…ƒç´ 
            modal = document.getElementById('time-picker-modal');
            hourColumn = document.getElementById('hour-column');
            minuteColumn = document.getElementById('minute-column');
            confirmButton = document.getElementById('confirm-button');
            cancelButton = document.getElementById('cancel-button');
            countdownDisplay = document.getElementById('countdown-display');
            mainContainer = document.querySelector('.container'); // åˆå§‹åŒ–ä¸»å®¹å™¨å…ƒç´ 

            // åŠ è½½è®¾ç½®
            loadSettings();

            // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
            initTimePicker();

            // åˆå§‹åŒ–å¤‡å¿˜å½•
            initMemo();

            // åˆå§‹åŒ–åº”ç”¨æ¡Œé¢
            initAppDrawer();
            initAppEditModal();

            // åˆå§‹æ›´æ–°
            updateCountdown();

            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(updateCountdown, 1000);

            // æ˜¾ç¤ºåŒæ­¥ç æç¤ºï¼ˆä»…é¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰
            const hasShownSyncTip = localStorage.getItem('bedtimeSyncTipShown');
            if (!hasShownSyncTip) {
                setTimeout(() => {
                    alert(`æ‚¨çš„å¤‡å¿˜å½•ç°åœ¨æ”¯æŒè·¨è®¾å¤‡åŒæ­¥ï¼\n\næ‚¨çš„åŒæ­¥ç æ˜¯: ${getSyncCode()}\n\nè¯·è®°ä½è¿™ä¸ªåŒæ­¥ç ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨å®ƒæ¥åŒæ­¥å¤‡å¿˜å½•å†…å®¹ã€‚\n\næç¤º: åŒå‡»å¤‡å¿˜å½•åŒºåŸŸå¯ä»¥éšæ—¶æŸ¥çœ‹æ‚¨çš„åŒæ­¥ç ã€‚\nåœ¨å…¶ä»–è®¾å¤‡ä¸Šï¼ŒæŒ‰Ctrl+Shift+Så¯ä»¥è¾“å…¥åŒæ­¥ç ã€‚`);
                    localStorage.setItem('bedtimeSyncTipShown', 'true');
                }, 2000);
            }
        };
    </script>

    <!-- Powered by æ–‡æœ¬ -->
    <div class="powered-by">Powered by Chaoâ¤ï¸</div>
</body>
</html>
